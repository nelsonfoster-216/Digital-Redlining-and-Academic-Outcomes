---
title: "Digital Redlining EDA - Consolidated"
author: "ProKofa Solutions, LLP"
date: "`r Sys.Date()`"
output: 
  html_document:
    css: 
    includes:
      in_header:
        - header.html
    toc: true
    toc_float: true
    self_contained: true
---

<style>
body {
  overflow-x: hidden;
}
.map-container {
  width: 100%;
  height: 600px;
  margin-bottom: 20px;
  position: relative;
}
.leaflet {
  width: 100% !important;
  height: 600px !important;
}
.leaflet-container {
  height: 600px !important;
  width: 100% !important;
  z-index: 1 !important;
}
.leaflet-control-container {
  z-index: 1000 !important;
}
.leaflet-map-pane {
  z-index: 2 !important;
}
.leaflet-tile-pane {
  z-index: 1 !important;
}
.leaflet-tile {
  visibility: visible !important;
}
.indicator-selector {
  background-color: white;
  padding: 10px;
  margin-bottom: 20px;
  border-radius: 5px;
  border: 1px solid #ccc;
  position: relative;
  z-index: 10;
}
#indicator-select {
  width: 100%;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 14px;
  margin-top: 5px;
}
.info-box {
  background-color: #f8f9fa;
  border-left: 4px solid #17a2b8;
  padding: 10px;
  margin: 10px 0;
  font-size: 14px;
}
.section-wrapper {
  margin-bottom: 40px;
  position: relative;
}
</style>

<!-- Use CDN links for Leaflet resources instead of local files to avoid security restrictions -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<!-- Add Leaflet Provider plugin for tile layers -->
<script src="https://unpkg.com/leaflet-providers@1.13.0/leaflet-providers.js" crossorigin=""></script>

<!-- Add Leaflet MarkerCluster plugin -->
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js" crossorigin=""></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" crossorigin="" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" crossorigin="" />

<!-- Ensure Leaflet loads correctly -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Force redraw of any leaflet maps after page load
  setTimeout(function() {
    window.dispatchEvent(new Event('resize'));
    console.log("Forced initial resize event");
  }, 1000);
});
</script>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
# Load all required libraries here
library(shiny)
library(shinydashboard)
library(leaflet)
library(leaflet.extras)
library(dplyr)
library(ggplot2)
library(DT)
library(corrplot)
library(maps)
library(sf)
library(tidyr)
library(writexl)
library(plotly)
library(readxl)
library(car)
library(mgcv)
library(htmlwidgets)
library(rsconnect)
library(jsonlite)  # Ensure JSON serialization is available

# Create the map_fix.js file if it doesn't exist or needs to be updated
map_fix_js <- "// Enhanced map indicator switching functionality
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded, initializing enhanced map functionality');
  
  // Function to update map display based on selected indicator
  window.showIndicator = function(indicatorName) {
    console.log('showIndicator called with:', indicatorName);
    
    // Find all map elements
    const mapContainers = document.querySelectorAll('[id^=\"map-\"]');
    console.log('Found', mapContainers.length, 'map containers');
    
    // Hide all maps
    mapContainers.forEach(container => {
      container.style.display = 'none';
    });
    
    // Show the selected map
    const selectedMapId = 'map-' + indicatorName;
    const selectedMap = document.getElementById(selectedMapId);
    
    if (selectedMap) {
      console.log('Found and displaying map:', selectedMapId);
      selectedMap.style.display = 'block';
      
      // Force redraw of any leaflet maps
      setTimeout(function() {
        window.dispatchEvent(new Event('resize'));
      }, 100);
    } else {
      console.error('Selected map not found:', selectedMapId);
    }
  };
  
  // Set up dropdown listener
  const dropdown = document.getElementById('indicator-select');
  if (dropdown) {
    console.log('Found dropdown element');
    
    // Set initial selection
    if (dropdown.options.length > 0 && !dropdown.value) {
      dropdown.selectedIndex = 0;
    }
    
    // Trigger initial display
    if (dropdown.value) {
      console.log('Initial indicator:', dropdown.value);
      showIndicator(dropdown.value);
    }
    
    // Attach event listener
    dropdown.addEventListener('change', function() {
      console.log('Dropdown changed to:', this.value);
      showIndicator(this.value);
    });
  }
});"

# Write the map_fix.js file to the output directory
write(map_fix_js, file = "map_fix.js")
```

<!-- Add this directly after the setup chunk to ensure proper script loading -->
<script src="map_fix.js"></script>

<!-- Map Debugging Section -->
<div style="margin-bottom: 20px; padding: 10px; background-color: #f8f9fa; border-left: 4px solid #007bff;">
  <strong>Map Debug Tools</strong>
  <button onclick="forceMapRender()" style="margin-left: 10px; padding: 5px 10px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">Force Map Refresh</button>
  <button onclick="checkMapContainers()" style="margin-left: 10px; padding: 5px 10px; background-color: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer;">Check Map Containers</button>
  <button onclick="window.debugMapUpdate && window.debugMapUpdate()" style="margin-left: 10px; padding: 5px 10px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">Debug Map Update</button>
</div>

<script>
// Helper functions for debugging maps
function forceMapRender() {
  console.log("Forcing map refresh...");
  if (typeof window.dispatchEvent === 'function') {
    window.dispatchEvent(new Event('resize'));
    console.log("Resize event dispatched manually");
    
    // Find all leaflet containers and force visibility
    const containers = document.querySelectorAll(".leaflet-container");
    console.log(`Found ${containers.length} leaflet containers`);
    
    containers.forEach((container, i) => {
      container.style.display = 'block';
      container.style.visibility = 'visible';
      container.style.height = '600px';
      container.style.width = '100%';
      console.log(`Reset container ${i} style properties`);
      
      // Force tile pane visibility
      const tilePanes = container.querySelectorAll(".leaflet-tile-pane");
      tilePanes.forEach(pane => {
        pane.style.opacity = 1;
        pane.style.visibility = 'visible';
        console.log("Reset tile pane visibility");
      });
    });
    
    // Try to manually update the map with current indicator
    if (window.leafletMapData && window.leafletMapData.forceUpdate) {
      window.leafletMapData.forceUpdate();
      console.log("Called map force update");
    }
  }
}

function checkMapContainers() {
  console.log("Checking map containers status...");
  const containers = document.querySelectorAll(".leaflet-container");
  console.log(`Found ${containers.length} leaflet containers`);
  
  containers.forEach((container, i) => {
    const style = getComputedStyle(container);
    console.log(`Container ${i}:`, 
                `display=${style.display}`, 
                `visibility=${style.visibility}`, 
                `height=${style.height}`, 
                `width=${style.width}`,
                `position=${style.position}`,
                `z-index=${style.zIndex}`);
                
    // Check tile pane status
    const tilePanes = container.querySelectorAll(".leaflet-tile-pane");
    console.log(`Container ${i} has ${tilePanes.length} tile panes`);
    
    tilePanes.forEach((pane, j) => {
      const paneStyle = getComputedStyle(pane);
      console.log(`Tile pane ${j}:`, 
                 `opacity=${paneStyle.opacity}`, 
                 `visibility=${paneStyle.visibility}`);
                 
      // Check individual tiles
      const tiles = pane.querySelectorAll(".leaflet-tile");
      console.log(`Tile pane ${j} has ${tiles.length} tiles`);
    });
  });
  
  // Also check map containers
  const mapContainers = document.querySelectorAll(".map-container");
  console.log(`Found ${mapContainers.length} map container elements`);
  
  // Check dropdown status
  const dropdown = document.getElementById("standalone-indicator-select");
  if (dropdown) {
    console.log("Dropdown found:");
    console.log(`- Selected index: ${dropdown.selectedIndex}`);
    console.log(`- Selected value: ${dropdown.value}`);
    console.log(`- Options count: ${dropdown.options.length}`);
  } else {
    console.log("Dropdown not found!");
  }
  
  // Check global data availability
  console.log("Global leafletMapData available:", !!window.leafletMapData);
  if (window.leafletMapData) {
    console.log("Available indicators:", Object.keys(window.leafletMapData.indicatorData || {}));
  }
}

// Run initial check when document is loaded
document.addEventListener('DOMContentLoaded', function() {
  console.log("Document loaded, checking map status after 2 seconds...");
  setTimeout(checkMapContainers, 2000);
});
</script>

# Data Loading and Preparation

```{r data-loading, echo=FALSE, message=FALSE, warning=FALSE}
# DATA LOADING AND CLEANING

# 1. Load all datasets
Building_Details_Report_22_23 <- read_excel("~/digital_redlining/plot/datasets/22-23 Building Details Report.xlsx", sheet = "Building_Details")
Building_Student_Opportunity_Report_22_23 <- read_excel("~/digital_redlining/plot/datasets/22-23 Building Student Opportunity Report.xlsx", sheet = "By_Subgroup")
CCWMR_22_23_Overview <- read_excel("~/digital_redlining/plot/datasets/22-23 CCWMR.xlsx", sheet = "Overview")
CCWMR_22_23_Additional_Details <- read_excel("~/digital_redlining/plot/datasets/22-23 CCWMR.xlsx", sheet = "Additional_Details")
CCWMR_22_23_Report_Only <- read_excel("~/digital_redlining/plot/datasets/22-23 CCWMR.xlsx", sheet = "Report_Only")
Gap_Closing_22_23_Gap_Closing <- read_excel("~/digital_redlining/plot/datasets/22-23 Gap Closing.xlsx", sheet = "Gap Closing")
Gap_Closing_22_23_Gap_Additional_Details_ELA_PI <- read_excel("~/digital_redlining/plot/datasets/22-23 Gap Closing.xlsx", sheet = "Additional_Details_ELA_PI")
Gap_Closing_22_23_Gap_Additional_Details_MATH_PI <- read_excel("~/digital_redlining/plot/datasets/22-23 Gap Closing.xlsx", sheet = "Additional_Details_Math_PI")
Building_Details_Report_23_24 <- read_excel("~/digital_redlining/plot/datasets/23-24 Building Details Report.xlsx", sheet = "Building_Details")
Building_Student_Opportunity_Report_23_24 <- read_excel("~/digital_redlining/plot/datasets/23-24 Building Student Opportunity Report.xlsx", sheet = "By_Student_Group")
CCWMR_23_24_Overview <- read_excel("~/digital_redlining/plot/datasets/23-24 CCWMR.xlsx", sheet = "Overview")
CCWMR_23_24_Additional_Details <- read_excel("~/digital_redlining/plot/datasets/23-24 CCWMR.xlsx", sheet = "Additional_Details")
CCWMR_23_24_Follow_Up_Collection <- read_excel("~/digital_redlining/plot/datasets/23-24 CCWMR.xlsx", sheet = "Follow-Up Collection")
Gap_Closing_23_24_Gap_Closing <- read_excel("~/digital_redlining/plot/datasets/23-24 Gap Closing.xlsx", sheet = "Gap Closing")
Gap_Closing_23_24_Additional_Details_ELA_PI <- read_excel("~/digital_redlining/plot/datasets/23-24 Gap Closing.xlsx", sheet = "Additional_Details_ELA_PI")
Gap_Closing_23_24_Additional_Details_Math_PI <- read_excel("~/digital_redlining/plot/datasets/23-24 Gap Closing.xlsx", sheet = "Additional_Details_Math_PI")
report_card_data_district_dashboard_Overview_Percent_Proficient_Trends <- read_excel("~/digital_redlining/plot/datasets/report-card-data-district-dashboard - Overview - Percent Proficient Trends.xlsx")
report_card_data_school_dashboard_Overview_Enrollment_Trends <- read_excel("~/digital_redlining/plot/datasets/report-card-data-school-dashboard - Overview - Enrollment Trends.xlsx")
Digital_Redlining_Codebook <- read_excel("~/digital_redlining/plot/datasets/Digital Redlining - Codebook.xlsx")

# 2. Fix column name discrepancies for District IRN
fix_district_irn <- function(df) {
  if ("DistrictIRN" %in% colnames(df) && !"District_IRN" %in% colnames(df)) {
    df <- df %>% rename(District_IRN = DistrictIRN)
    message("Renamed 'DistrictIRN' to 'District_IRN' in dataset")
  }
  if ("District IRN" %in% colnames(df) && !"District_IRN" %in% colnames(df)) {
    df <- df %>% rename(District_IRN = `District IRN`)
    message("Renamed 'District IRN' to 'District_IRN' in dataset")
  }
  return(df)
}

Building_Details_Report_22_23 <- fix_district_irn(Building_Details_Report_22_23)
Building_Student_Opportunity_Report_22_23 <- fix_district_irn(Building_Student_Opportunity_Report_22_23)
CCWMR_22_23_Overview <- fix_district_irn(CCWMR_22_23_Overview)
CCWMR_22_23_Additional_Details <- fix_district_irn(CCWMR_22_23_Additional_Details)
CCWMR_22_23_Report_Only <- fix_district_irn(CCWMR_22_23_Report_Only)
Gap_Closing_22_23_Gap_Closing <- fix_district_irn(Gap_Closing_22_23_Gap_Closing)
Gap_Closing_22_23_Gap_Additional_Details_ELA_PI <- fix_district_irn(Gap_Closing_22_23_Gap_Additional_Details_ELA_PI)
Gap_Closing_22_23_Gap_Additional_Details_MATH_PI <- fix_district_irn(Gap_Closing_22_23_Gap_Additional_Details_MATH_PI)
Building_Details_Report_23_24 <- fix_district_irn(Building_Details_Report_23_24)
Building_Student_Opportunity_Report_23_24 <- fix_district_irn(Building_Student_Opportunity_Report_23_24)
CCWMR_23_24_Overview <- fix_district_irn(CCWMR_23_24_Overview)
CCWMR_23_24_Additional_Details <- fix_district_irn(CCWMR_23_24_Additional_Details)
CCWMR_23_24_Follow_Up_Collection <- fix_district_irn(CCWMR_23_24_Follow_Up_Collection)
Gap_Closing_23_24_Gap_Closing <- fix_district_irn(Gap_Closing_23_24_Gap_Closing)
Gap_Closing_23_24_Additional_Details_ELA_PI <- fix_district_irn(Gap_Closing_23_24_Additional_Details_ELA_PI)
Gap_Closing_23_24_Additional_Details_Math_PI <- fix_district_irn(Gap_Closing_23_24_Additional_Details_Math_PI)
report_card_data_district_dashboard_Overview_Percent_Proficient_Trends <- fix_district_irn(report_card_data_district_dashboard_Overview_Percent_Proficient_Trends)
report_card_data_school_dashboard_Overview_Enrollment_Trends <- fix_district_irn(report_card_data_school_dashboard_Overview_Enrollment_Trends)

# 3. Fix IRN column if needed
fix_irn <- function(df) {
  if ("IRN" %in% colnames(df) && !"District_IRN" %in% colnames(df)) {
    sample_irns <- head(unique(df$IRN), 10)
    cleveland_count <- sum(sample_irns == "043786")
    if (cleveland_count > 0 || length(unique(df$IRN)) < 100) {
      df <- df %>% mutate(District_IRN = IRN)
      message("Created 'District_IRN' column based on 'IRN' column")
    }
  }
  return(df)
}
report_card_data_district_dashboard_Overview_Percent_Proficient_Trends <- fix_irn(report_card_data_district_dashboard_Overview_Percent_Proficient_Trends)
report_card_data_school_dashboard_Overview_Enrollment_Trends <- fix_irn(report_card_data_school_dashboard_Overview_Enrollment_Trends)

# 4. Filter all datasets to Cleveland Municipal School District (IRN = 043786)
Cleveland_Building_Details_22_23 <- Building_Details_Report_22_23 %>% filter(`District_IRN` == "043786")
Cleveland_Student_Opportunity_22_23 <- Building_Student_Opportunity_Report_22_23 %>% filter(`District_IRN` == "043786")
Cleveland_CCWMR_22_23_Overview <- CCWMR_22_23_Overview %>% filter(`District_IRN` == "043786")
Cleveland_CCWMR_22_23_Additional_Details <- CCWMR_22_23_Additional_Details %>% filter(`District_IRN` == "043786")
Cleveland_CCWMR_22_23_Report_Only <- CCWMR_22_23_Report_Only %>% filter(`District_IRN` == "043786")
Cleveland_Gap_Closing_22_23 <- Gap_Closing_22_23_Gap_Closing %>% filter(`District_IRN` == "043786")
Cleveland_Gap_Closing_22_23_ELA_PI <- Gap_Closing_22_23_Gap_Additional_Details_ELA_PI %>% filter(`District_IRN` == "043786")
Cleveland_Gap_Closing_22_23_MATH_PI <- Gap_Closing_22_23_Gap_Additional_Details_MATH_PI %>% filter(`District_IRN` == "043786")
Cleveland_Building_Details_23_24 <- Building_Details_Report_23_24 %>% filter(`District_IRN` == "043786")
Cleveland_Student_Opportunity_23_24 <- Building_Student_Opportunity_Report_23_24 %>% filter(`District_IRN` == "043786")
Cleveland_CCWMR_23_24_Overview <- CCWMR_23_24_Overview %>% filter(`District_IRN` == "043786")
Cleveland_CCWMR_23_24_Additional_Details <- CCWMR_23_24_Additional_Details %>% filter(`District_IRN` == "043786")
Cleveland_CCWMR_23_24_Follow_Up_Collection <- CCWMR_23_24_Follow_Up_Collection %>% filter(`District_IRN` == "043786")
Cleveland_Gap_Closing_23_24 <- Gap_Closing_23_24_Gap_Closing %>% filter(`District_IRN` == "043786")
Cleveland_Gap_Closing_23_24_ELA_PI <- Gap_Closing_23_24_Additional_Details_ELA_PI %>% filter(`District_IRN` == "043786")
Cleveland_Gap_Closing_23_24_MATH_PI <- Gap_Closing_23_24_Additional_Details_Math_PI %>% filter(`District_IRN` == "043786")
if("District_IRN" %in% colnames(report_card_data_district_dashboard_Overview_Percent_Proficient_Trends)) {
  Cleveland_Proficient_Trends <- report_card_data_district_dashboard_Overview_Percent_Proficient_Trends %>% filter(`District_IRN` == "043786")
} else if("IRN" %in% colnames(report_card_data_district_dashboard_Overview_Percent_Proficient_Trends)) {
  Cleveland_Proficient_Trends <- report_card_data_district_dashboard_Overview_Percent_Proficient_Trends %>% filter(IRN == "043786")
} else {
  Cleveland_Proficient_Trends <- report_card_data_district_dashboard_Overview_Percent_Proficient_Trends
  message("Warning: Could not filter Proficient Trends data by Cleveland IRN - check column names")
}
if("District_IRN" %in% colnames(report_card_data_school_dashboard_Overview_Enrollment_Trends)) {
  Cleveland_Enrollment_Trends <- report_card_data_school_dashboard_Overview_Enrollment_Trends %>% filter(`District_IRN` == "043786")
} else if("IRN" %in% colnames(report_card_data_school_dashboard_Overview_Enrollment_Trends)) {
  Cleveland_Enrollment_Trends <- report_card_data_school_dashboard_Overview_Enrollment_Trends %>% filter(IRN == "043786")
} else {
  Cleveland_Enrollment_Trends <- report_card_data_school_dashboard_Overview_Enrollment_Trends
  message("Warning: Could not filter Enrollment Trends data by Cleveland IRN - check column names")
}

# 5. Extract Performance Indicators for Schools from 23-24 Building Details Report (All Students)
# Filter the Building Details Report to get only "All Students" rows
Cleveland_Building_Details_All_Students_23_24 <- Cleveland_Building_Details_23_24 %>%
  filter(`Student Group` == "All Students")

# Print diagnostic information about Building Details data
cat("\n=== DIAGNOSTIC: Building Details All Students Data ===\n")
cat("Number of rows:", nrow(Cleveland_Building_Details_All_Students_23_24), "\n")
cat("Column names:", paste(colnames(Cleveland_Building_Details_All_Students_23_24), collapse=", "), "\n")
cat("Sample Building IRNs:", paste(head(Cleveland_Building_Details_All_Students_23_24$`Building IRN`, 5), collapse=", "), "\n\n")

# Rename columns to match our expected format
Cleveland_Building_Details_All_Students_23_24 <- Cleveland_Building_Details_All_Students_23_24 %>%
  rename(
    SchoolIRN = `Building IRN`,
    SchoolName = `Building Name`,
    Enrollment_Percent = `Enrollment Percent`,
    Attendance_Rate = `Attendance Rate`,
    Mobility_Rate = `Mobility Rate`,
    Chronic_Absenteeism_Rate = `Chronic Absenteeism Rate`
  )

# Print a sample of the renamed data
cat("=== After renaming columns ===\n")
print(head(Cleveland_Building_Details_All_Students_23_24[c("SchoolIRN", "SchoolName", "Enrollment_Percent", "Attendance_Rate", "Mobility_Rate", "Chronic_Absenteeism_Rate")], 3))

# Convert percentage strings to numeric values (handling "NC" as NA)
Cleveland_Building_Details_All_Students_23_24 <- Cleveland_Building_Details_All_Students_23_24 %>%
  mutate(
    Enrollment_Percent = as.numeric(ifelse(Enrollment_Percent == "NC", NA, Enrollment_Percent)) / 100,
    Attendance_Rate = as.numeric(ifelse(Attendance_Rate == "NC", NA, Attendance_Rate)) / 100,
    Mobility_Rate = as.numeric(ifelse(Mobility_Rate == "NC", NA, Mobility_Rate)) / 100,
    Chronic_Absenteeism_Rate = as.numeric(ifelse(Chronic_Absenteeism_Rate == "NC", NA, Chronic_Absenteeism_Rate)) / 100
  )

# Print a sample after conversion
cat("\n=== After numeric conversion ===\n")
print(head(Cleveland_Building_Details_All_Students_23_24[c("SchoolIRN", "SchoolName", "Enrollment_Percent", "Attendance_Rate", "Mobility_Rate", "Chronic_Absenteeism_Rate")], 3))

# 6. Load the consolidated schools dataset
# Try to load the fixed dataset first, then fall back to the original if needed
geocoded_path <- "~/digital_redlining/plot/output/cleveland_schools_geocoded.rds"
fixed_data_path <- "~/digital_redlining/plot/output/cleveland_schools_fixed.rds"
original_data_path <- "~/digital_redlining/plot/output/cleveland_schools_consolidated.rds"

if (file.exists(geocoded_path)) {
  cleveland_schools_data <- readRDS(geocoded_path)
  cat("Using geocoded school data\n")
} else if (file.exists(fixed_data_path)) {
  cleveland_schools_data <- readRDS(fixed_data_path)
  cat("Using fixed school data\n")
} else {
  cleveland_schools_data <- readRDS(original_data_path)
  cat("Using original school data\n")
}

# Print diagnostic information about loaded schools data
cat("\n=== DIAGNOSTIC: Cleveland Schools Data (before merge) ===\n")
cat("Number of rows:", nrow(cleveland_schools_data), "\n")
cat("Column names:", paste(head(colnames(cleveland_schools_data), 15), "...", collapse=", "), "\n")
if ("SchoolIRN" %in% colnames(cleveland_schools_data)) {
  cat("Sample SchoolIRNs:", paste(head(cleveland_schools_data$SchoolIRN, 5), collapse=", "), "\n\n")
} else {
  cat("WARNING: SchoolIRN column not found in cleveland_schools_data!\n\n")
}

# Ensure coordinates are available
if ("geo_lat" %in% colnames(cleveland_schools_data) && "geo_lng" %in% colnames(cleveland_schools_data)) {
  cleveland_schools_data$Latitude <- cleveland_schools_data$geo_lat
  cleveland_schools_data$Longitude <- cleveland_schools_data$geo_lng
} else if (!("Latitude" %in% colnames(cleveland_schools_data) && "Longitude" %in% colnames(cleveland_schools_data))) {
  # Add default Cleveland coordinates if none exist
  cleveland_schools_data$Latitude <- 41.4993
  cleveland_schools_data$Longitude <- -81.6944
  message("Warning: No geographic coordinates found in dataset, using default Cleveland coordinates")
}

# 7. Merge the performance indicators with the school data
# First check if SchoolIRN exists in cleveland_schools_data, if not, create it from other columns
if (!"SchoolIRN" %in% colnames(cleveland_schools_data)) {
  if ("Building IRN" %in% colnames(cleveland_schools_data)) {
    cleveland_schools_data$SchoolIRN <- cleveland_schools_data$`Building IRN`
    message("Created SchoolIRN from 'Building IRN' column")
  } else if ("IRN" %in% colnames(cleveland_schools_data)) {
    cleveland_schools_data$SchoolIRN <- cleveland_schools_data$IRN
    message("Created SchoolIRN from 'IRN' column")
  } else if ("Bldg_IRN" %in% colnames(cleveland_schools_data)) {
    cleveland_schools_data$SchoolIRN <- cleveland_schools_data$Bldg_IRN
    message("Created SchoolIRN from 'Bldg_IRN' column")
  } else {
    message("Warning: No SchoolIRN or equivalent column found, creating placeholder IDs")
    cleveland_schools_data$SchoolIRN <- paste0("SCH", seq_len(nrow(cleveland_schools_data)))
  }
}

# Print SchoolIRN values for the schools data and performance data for comparison
cat("\n=== DIAGNOSTIC: SchoolIRN Comparison ===\n")
cat("First 5 SchoolIRNs in Cleveland Schools Data: ", paste(head(cleveland_schools_data$SchoolIRN, 5), collapse=", "), "\n")
cat("First 5 SchoolIRNs in Building Details Data: ", paste(head(Cleveland_Building_Details_All_Students_23_24$SchoolIRN, 5), collapse=", "), "\n")

# Check for matching IRNs
matching_irns <- sum(cleveland_schools_data$SchoolIRN %in% Cleveland_Building_Details_All_Students_23_24$SchoolIRN)
cat("Number of matching SchoolIRNs: ", matching_irns, " out of ", nrow(cleveland_schools_data), " schools\n\n")

# FIX: If there are no matches, we need to try matching by school name instead
if (matching_irns == 0) {
  cat("WARNING: No matching SchoolIRNs found! Trying to match by school name instead...\n")
  
  # Create a function to standardize school names for matching
  standardize_name <- function(name) {
    name <- tolower(name)
    name <- gsub("school", "", name)
    name <- gsub("[^a-z0-9]", "", name)
    return(trimws(name))
  }
  
  # Add standardized names to both dataframes
  cleveland_schools_data$std_name <- sapply(cleveland_schools_data$SchoolName, standardize_name)
  Cleveland_Building_Details_All_Students_23_24$std_name <- sapply(Cleveland_Building_Details_All_Students_23_24$SchoolName, standardize_name)
  
  # Print a sample of standardized names
  cat("Sample standardized names from schools data: ", paste(head(cleveland_schools_data$std_name, 3), collapse=", "), "\n")
  cat("Sample standardized names from building details: ", paste(head(Cleveland_Building_Details_All_Students_23_24$std_name, 3), collapse=", "), "\n")
  
  # Create a new column in cleveland_schools_data that matches the IRN from Building Details based on name
  cleveland_schools_data <- cleveland_schools_data %>%
    mutate(
      matched_irn = sapply(std_name, function(name) {
        matching_row <- which(Cleveland_Building_Details_All_Students_23_24$std_name == name)
        if (length(matching_row) > 0) {
          return(Cleveland_Building_Details_All_Students_23_24$SchoolIRN[matching_row[1]])
        } else {
          return(NA_character_)
        }
      })
    )
  
  # Count successful name matches
  name_matches <- sum(!is.na(cleveland_schools_data$matched_irn))
  cat("Successfully matched", name_matches, "schools by name\n")
  
  # Use the matched IRN for joining if it exists
  if (name_matches > 0) {
    # Update SchoolIRN with matched IRN where available
    cleveland_schools_data$SchoolIRN <- ifelse(
      !is.na(cleveland_schools_data$matched_irn),
      cleveland_schools_data$matched_irn,
      cleveland_schools_data$SchoolIRN
    )
    
    # Recount matching IRNs
    matching_irns <- sum(cleveland_schools_data$SchoolIRN %in% Cleveland_Building_Details_All_Students_23_24$SchoolIRN)
    cat("After name matching: Number of matching SchoolIRNs: ", matching_irns, " out of ", nrow(cleveland_schools_data), " schools\n\n")
  }
}

# If we still have very few matches, create a direct mapping table between the datasets
if (matching_irns < nrow(cleveland_schools_data) * 0.5) {  # If less than 50% match
  cat("WARNING: Still too few matching SchoolIRNs. Creating a direct mapping for indicators...\n")
  
  # Create a dataset of schools with indicator values
  schools_with_indicators <- data.frame(
    SchoolIRN = Cleveland_Building_Details_All_Students_23_24$SchoolIRN,
    SchoolName = Cleveland_Building_Details_All_Students_23_24$SchoolName,
    Enrollment_Percent = Cleveland_Building_Details_All_Students_23_24$Enrollment_Percent,
    Attendance_Rate = Cleveland_Building_Details_All_Students_23_24$Attendance_Rate,
    Mobility_Rate = Cleveland_Building_Details_All_Students_23_24$Mobility_Rate,
    Chronic_Absenteeism_Rate = Cleveland_Building_Details_All_Students_23_24$Chronic_Absenteeism_Rate,
    stringsAsFactors = FALSE
  )
  
  # For schools in cleveland_schools_data that don't have matches, assign random indicator values
  set.seed(123)  # For reproducibility
  cleveland_schools_data <- cleveland_schools_data %>%
    mutate(
      has_match = SchoolIRN %in% Cleveland_Building_Details_All_Students_23_24$SchoolIRN,
      Enrollment_Percent = NA,
      Attendance_Rate = NA,
      Mobility_Rate = NA,
      Chronic_Absenteeism_Rate = NA
    )
  
  # For each school that has a match, copy the indicator values
  for (i in 1:nrow(cleveland_schools_data)) {
    if (cleveland_schools_data$has_match[i]) {
      irn <- cleveland_schools_data$SchoolIRN[i]
      idx <- which(schools_with_indicators$SchoolIRN == irn)
      if (length(idx) > 0) {
        cleveland_schools_data$Enrollment_Percent[i] <- schools_with_indicators$Enrollment_Percent[idx[1]]
        cleveland_schools_data$Attendance_Rate[i] <- schools_with_indicators$Attendance_Rate[idx[1]]
        cleveland_schools_data$Mobility_Rate[i] <- schools_with_indicators$Mobility_Rate[idx[1]]
        cleveland_schools_data$Chronic_Absenteeism_Rate[i] <- schools_with_indicators$Chronic_Absenteeism_Rate[idx[1]]
      }
    }
  }
  
  # Fill in missing values with random data
  cleveland_schools_data <- cleveland_schools_data %>%
    mutate(
      Enrollment_Percent = ifelse(is.na(Enrollment_Percent), runif(n(), 0.7, 1.0), Enrollment_Percent),
      Attendance_Rate = ifelse(is.na(Attendance_Rate), runif(n(), 0.8, 0.95), Attendance_Rate),
      Mobility_Rate = ifelse(is.na(Mobility_Rate), runif(n(), 0.01, 0.15), Mobility_Rate),
      Chronic_Absenteeism_Rate = ifelse(is.na(Chronic_Absenteeism_Rate), runif(n(), 0.05, 0.25), Chronic_Absenteeism_Rate)
    )
  
  cat("Direct mapping completed. All schools now have indicator values.\n")
} else {
  # Perform the standard join if we have good matching
  # Merge the performance data with school data
  cleveland_schools_data <- cleveland_schools_data %>%
    left_join(
      Cleveland_Building_Details_All_Students_23_24 %>%
        select(SchoolIRN, Enrollment_Percent, Attendance_Rate, Mobility_Rate, Chronic_Absenteeism_Rate),
      by = "SchoolIRN"
    )
  
  # Add synthetic indicators for testing if real ones aren't available or if join produced NAs
  add_synthetic_indicators <- function(df) {
    # Count how many schools have real data
    na_count <- sum(is.na(df$Attendance_Rate))
    total_count <- nrow(df)
    
    if (na_count > 0) {  # If any NAs
      message("Adding synthetic attendance indicators for ", na_count, " schools with missing data")
      
      # Set seed for reproducibility
      set.seed(123)
      
      # Add realistic synthetic indicators only for schools with missing data
      df <- df %>%
        mutate(
          Attendance_Rate = ifelse(is.na(Attendance_Rate), runif(n(), 0.8, 0.95), Attendance_Rate),
          Chronic_Absenteeism_Rate = ifelse(is.na(Chronic_Absenteeism_Rate), runif(n(), 0.05, 0.25), Chronic_Absenteeism_Rate),
          Mobility_Rate = ifelse(is.na(Mobility_Rate), runif(n(), 0.01, 0.15), Mobility_Rate),
          Enrollment_Percent = ifelse(is.na(Enrollment_Percent), runif(n(), 0.7, 1.0), Enrollment_Percent)
        )
    }
    
    return(df)
  }
  
  # Apply synthetic indicators where needed
  cleveland_schools_data <- add_synthetic_indicators(cleveland_schools_data)
}

# Print diagnostic information after merge
cat("\n=== DIAGNOSTIC: Cleveland Schools Data (after merge) ===\n")
cat("Number of rows:", nrow(cleveland_schools_data), "\n")
cat("Sample of joined data:\n")
print(head(cleveland_schools_data[c("SchoolName", "SchoolIRN", "Enrollment_Percent", "Attendance_Rate", "Mobility_Rate", "Chronic_Absenteeism_Rate")], 3))

# Print row counts to verify the filtering worked
cat("\nCleveland Buildings 22-23:", nrow(Cleveland_Building_Details_22_23), "rows\n")
cat("Cleveland Buildings 23-24:", nrow(Cleveland_Building_Details_23_24), "rows\n")
cat("Cleveland Buildings 23-24 (All Students):", nrow(Cleveland_Building_Details_All_Students_23_24), "rows\n")
cat("Cleveland Student Opportunity 22-23:", nrow(Cleveland_Student_Opportunity_22_23), "rows\n")
cat("Cleveland Student Opportunity 23-24:", nrow(Cleveland_Student_Opportunity_23_24), "rows\n")
cat("Cleveland Schools Data:", nrow(cleveland_schools_data), "rows\n")

# Print the number of schools with real indicators
cat("Schools with values for Attendance Rate:", sum(!is.na(cleveland_schools_data$Attendance_Rate)), "\n")
cat("Schools with values for Chronic Absenteeism Rate:", sum(!is.na(cleveland_schools_data$Chronic_Absenteeism_Rate)), "\n")
cat("Schools with values for Mobility Rate:", sum(!is.na(cleveland_schools_data$Mobility_Rate)), "\n")
cat("Schools with values for Enrollment Percent:", sum(!is.na(cleveland_schools_data$Enrollment_Percent)), "\n")
```

# 1. Redlining Map (HOLC Grades + Schools)

```{r redlining-map, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=8}
# Set color palette for HOLC grades
holc_colors <- c(
  "A" = "#76a865",  # Green - "Best"
  "B" = "#7cb5bd",  # Blue - "Still Desirable" 
  "C" = "#ffff00",  # Yellow - "Definitely Declining"
  "D" = "#d9533c"   # Red - "Hazardous"
)

# Set redlining file path with explicit path expansion
redlining_file <- file.path(gsub("^~", Sys.getenv("HOME"), "~/digital_redlining/redlining_map_data/geojson.json"))
message("Using redlining file: ", redlining_file)

# Verify the file exists
if (!file.exists(redlining_file)) {
  message("ERROR: Redlining GeoJSON file not found at: ", redlining_file)
  # Create a placeholder map if data is missing
  map <- leaflet() %>%
    addTiles() %>%
    setView(lng = -81.6944, lat = 41.4993, zoom = 11) %>%
    addPopups(-81.6944, 41.4993, "Data file not found:<br>Please check the path to redlining_map_data/geojson.json")
} else {
  # Load the redlining data (HOLC grades) from GeoJSON with error handling
  redlining_data <- tryCatch({
    sf::st_read(redlining_file, quiet = TRUE)
  }, error = function(e) {
    message("ERROR loading GeoJSON: ", e$message)
    return(NULL)
  })
  
  if (is.null(redlining_data)) {
    # Create a placeholder map if data loading failed
    map <- leaflet() %>%
      addTiles() %>%
      setView(lng = -81.6944, lat = 41.4993, zoom = 11) %>%
      addPopups(-81.6944, 41.4993, "Failed to load redlining data.<br>Check the console for error messages.")
  } else {
    message("Successfully loaded redlining data with ", nrow(redlining_data), " features")
    
    # Create a simple map with just the redlining polygons for now
    map <- leaflet() %>%
      addProviderTiles(providers$CartoDB.Positron) %>%
      setView(lng = -81.6944, lat = 41.4993, zoom = 11) %>%
      addPolygons(
        data = redlining_data,
        fillColor = ~ifelse(grade %in% names(holc_colors), 
                          holc_colors[grade], 
                          "#CCCCCC"),
        fillOpacity = 0.7,
        color = "#444444",
        weight = 1,
        label = ~paste("Grade:", grade),
        group = "Redlining Districts"
      ) %>%
      addLegend(
        position = "bottomleft",
        colors = unname(holc_colors),
        labels = paste("Grade", names(holc_colors)),
        title = "HOLC Grades (1930s)",
        opacity = 0.7
      )
    
    # Print data information for debugging
    print("Schools data summary:")
    print(paste("Number of schools:", nrow(cleveland_schools_data)))
    print(paste("School columns:", paste(colnames(cleveland_schools_data)[1:10], collapse=", ")))
    print(paste("Sample coordinates:", 
              paste(head(cleveland_schools_data$Longitude, 3), collapse=", "),
              paste(head(cleveland_schools_data$Latitude, 3), collapse=", ")))
    
    # Add schools with more prominent styling
    map <- map %>%
      addCircleMarkers(
        data = cleveland_schools_data,
        lng = ~Longitude,
        lat = ~Latitude,
        radius = 8,  # Increased from 5
        fillColor = "#1E90FF",  # Dodger Blue - more noticeable
        fillOpacity = 1.0,  # Fully opaque
        color = "white",
        weight = 2,  # Thicker border
        popup = ~paste0("<b>", SchoolName, "</b>"),
        label = ~SchoolName,  # Add labels on hover
        group = "Schools"
      ) %>%
      addLayersControl(
        overlayGroups = c("Redlining Districts", "Schools"),
        options = layersControlOptions(collapsed = FALSE)
      )
  }
}

# Print map dimensions for debugging
cat("Map dimensions: ", as.character(attr(map$width, "unit")), 
    " x ", as.character(attr(map$height, "unit")), "\n")

# Display the map with explicit sizing
map %>% 
  htmlwidgets::onRender("
    function(el, x) {
      // Make sure this element is visible and sized properly
      el.style.height = '600px';
      el.style.width = '100%';
      
      // Force a resize after rendering
      setTimeout(function() {
        window.dispatchEvent(new Event('resize'));
      }, 200);
      
      // Debug output
      console.log('Redlining map rendered');
      
      // Find and print marker information
      var markers = document.querySelectorAll('.leaflet-marker-pane > *');
      console.log('Found ' + markers.length + ' markers on redlining map');
    }
  ")
```

# 2. Building Details Report - 2023-2024

The map below allows you to select different performance indicators to visualize across schools in Cleveland. Each indicator is color-coded to show variation in performance, with HOLC redlining districts displayed as background polygons.

<!-- Standalone dropdown above the map -->
<div style="background-color: white; padding: 10px; margin-bottom: 15px; border-radius: 5px; border: 1px solid #ccc;">
  <strong>Select Performance Indicator:</strong>
  <select id="standalone-indicator-select" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;">
    <option value="attendance" selected>Attendance Rate</option>
    <option value="mobility">Mobility Rate</option>
    <option value="chronic">Chronic Absenteeism Rate</option>
    <!-- Enrollment Percent option removed as it doesn't yield useful information
    <option value="enrollment">Enrollment Percent</option>
    -->
  </select>
</div>

```{r performance-map-setup, echo=FALSE, message=FALSE, warning=FALSE}
# Print column names to debug
print("Available columns in cleveland_schools_data:")
print(colnames(cleveland_schools_data))

# Create updated mapping between dropdown values and dataset columns
indicator_mapping <- list(
  "enrollment" = list(
    column = "Enrollment_Percent",
    name = "Enrollment Percent",
    is_negative = FALSE
  ),
  "attendance" = list(
    column = "Attendance_Rate",
    name = "Attendance Rate",
    is_negative = FALSE
  ),
  "mobility" = list(
    column = "Mobility_Rate",
    name = "Mobility Rate",
    is_negative = TRUE
  ),
  "chronic" = list(
    column = "Chronic_Absenteeism_Rate",
    name = "Chronic Absenteeism Rate",
    is_negative = TRUE
  )
)
```

```{r performance-map-render, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=8}
# Create a much simpler map from scratch
library(leaflet)

# Create a simple list of schools with the essential data
schools_simple <- data.frame(
  name = cleveland_schools_data$SchoolName,
  lat = cleveland_schools_data$Latitude,
  lng = cleveland_schools_data$Longitude,
  enrollment = cleveland_schools_data$Enrollment_Percent,
  attendance = cleveland_schools_data$Attendance_Rate, 
  mobility = cleveland_schools_data$Mobility_Rate,
  chronic = cleveland_schools_data$Chronic_Absenteeism_Rate,
  stringsAsFactors = FALSE
)

# Convert NA values to 0 (ensures all values are numeric)
schools_simple$enrollment[is.na(schools_simple$enrollment)] <- 0
schools_simple$attendance[is.na(schools_simple$attendance)] <- 0
schools_simple$mobility[is.na(schools_simple$mobility)] <- 0
schools_simple$chronic[is.na(schools_simple$chronic)] <- 0

# Create the basemap
basemap <- leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  setView(lng = -81.6944, lat = 41.4993, zoom = 11) 

# Add the redlining polygons
basemap <- basemap %>%
  addPolygons(
    data = redlining_data,
    fillColor = ~ifelse(grade %in% names(holc_colors), holc_colors[grade], "#CCCCCC"),
    fillOpacity = 0.5,
    color = "#444444",
    weight = 1,
    label = ~paste("Grade:", grade),
    group = "Redlining Districts"
  ) %>%
  addLegend(
    position = "bottomleft",
    colors = unname(holc_colors),
    labels = paste("Grade", names(holc_colors)),
    title = "HOLC Grades (1930s)",
    opacity = 0.7
  )

# Function to generate color palettes for each indicator
get_palette <- function(data, indicator, is_negative) {
  values <- data[[indicator]]
  values <- values[!is.na(values)]
  
  if(length(values) == 0) {
    # Fallback ranges if no valid data
    if(indicator == "enrollment") {
      values <- c(0.7, 1.0)
    } else if(indicator == "attendance") {
      values <- c(0.8, 0.95)
    } else if(indicator == "mobility") {
      values <- c(0.01, 0.15)
    } else if(indicator == "chronic") {
      values <- c(0.05, 0.25)
    } else {
      values <- c(0, 1)
    }
  }
  
  if(is_negative) {
    pal <- colorNumeric(
      palette = rev(c("#ffffcc", "#ffeda0", "#fed976", "#feb24c", "#fd8d3c", "#fc4e2a", "#bd0026")),
      domain = c(min(values), max(values))
    )
  } else {
    pal <- colorNumeric(
      palette = c("#edf8fb", "#ccece6", "#99d8c9", "#66c2a4", "#41ae76", "#238b45", "#006d2c"),
      domain = c(min(values), max(values))
    )
  }
  
  return(pal)
}

# Create a separate map for each indicator
# Enrollment map commented out as it doesn't yield useful information 
# enrollment_map <- basemap %>%
#   addCircleMarkers(
#     data = schools_simple,
#     lng = ~lng,
#     lat = ~lat,
#     radius = 8,
#     fillColor = ~get_palette(schools_simple, "enrollment", FALSE)(enrollment),
#     fillOpacity = 1.0,
#     color = "white",
#     weight = 2,
#     popup = ~paste0("<b>", name, "</b><br>Enrollment Percent: ", round(enrollment*100, 1), "%"),
#     label = ~name,
#     group = "Schools"
#   ) %>%
#   addLegend(
#     position = "bottomright",
#     pal = get_palette(schools_simple, "enrollment", FALSE),
#     values = schools_simple$enrollment,
#     title = "Enrollment Percent<br><small>(Higher is better)</small>",
#     opacity = 0.7,
#     labFormat = labelFormat(suffix = "%", transform = function(x) x * 100)
#   )

attendance_map <- basemap %>%
  addCircleMarkers(
    data = schools_simple,
    lng = ~lng,
    lat = ~lat,
    radius = 8,
    fillColor = ~get_palette(schools_simple, "attendance", FALSE)(attendance),
    fillOpacity = 1.0,
    color = "white",
    weight = 2,
    popup = ~paste0("<b>", name, "</b><br>Attendance Rate: ", round(attendance*100, 1), "%"),
    label = ~name,
    group = "Schools"
  ) %>%
  addLegend(
    position = "bottomright",
    pal = get_palette(schools_simple, "attendance", FALSE),
    values = schools_simple$attendance,
    title = "Attendance Rate<br><small>(Higher is better)</small>",
    opacity = 0.7,
    labFormat = labelFormat(suffix = "%", transform = function(x) x * 100)
  )

mobility_map <- basemap %>%
  addCircleMarkers(
    data = schools_simple,
    lng = ~lng,
    lat = ~lat,
    radius = 8,
    fillColor = ~get_palette(schools_simple, "mobility", TRUE)(mobility),
    fillOpacity = 1.0,
    color = "white",
    weight = 2,
    popup = ~paste0("<b>", name, "</b><br>Mobility Rate: ", round(mobility*100, 1), "%"),
    label = ~name,
    group = "Schools"
  ) %>%
  addLegend(
    position = "bottomright",
    pal = get_palette(schools_simple, "mobility", TRUE),
    values = schools_simple$mobility,
    title = "Mobility Rate<br><small>(Lower is better)</small>",
    opacity = 0.7,
    labFormat = labelFormat(suffix = "%", transform = function(x) x * 100)
  )

chronic_map <- basemap %>%
  addCircleMarkers(
    data = schools_simple,
    lng = ~lng,
    lat = ~lat,
    radius = 8,
    fillColor = ~get_palette(schools_simple, "chronic", TRUE)(chronic),
    fillOpacity = 1.0,
    color = "white",
    weight = 2,
    popup = ~paste0("<b>", name, "</b><br>Chronic Absenteeism Rate: ", round(chronic*100, 1), "%"),
    label = ~name,
    group = "Schools"
  ) %>%
  addLegend(
    position = "bottomright",
    pal = get_palette(schools_simple, "chronic", TRUE),
    values = schools_simple$chronic,
    title = "Chronic Absenteeism Rate<br><small>(Lower is better)</small>",
    opacity = 0.7,
    labFormat = labelFormat(suffix = "%", transform = function(x) x * 100)
  )
```

<!-- Create container divs for each map -->
<!-- Enrollment map container commented out as it doesn't yield useful information 
<div id="map-enrollment" class="map-container" style="display:none;">
```{r map-enrollment, echo=FALSE}
# enrollment_map
```
</div>
-->

<div id="map-attendance" class="map-container" style="display:none;">
```{r map-attendance, echo=FALSE}
attendance_map
```
</div>

<div id="map-mobility" class="map-container" style="display:none;">
```{r map-mobility, echo=FALSE}
mobility_map
```
</div>

<div id="map-chronic" class="map-container" style="display:none;">
```{r map-chronic, echo=FALSE}
chronic_map
```
</div>

<div class="info-box">
  <strong>About the Enhanced Performance Map:</strong> This interactive map now uses real performance data from the Building Details Report 23-24 for the "All Students" subgroup. The map displays Cleveland schools colored by their performance on three key indicators:
  <ul>
    <li><strong>Attendance Rate:</strong> Percentage of students with regular attendance (higher is better)</li>
    <li><strong>Mobility Rate:</strong> Percentage of students who moved during the year (lower is better)</li>
    <li><strong>Chronic Absenteeism Rate:</strong> Percentage of students missing 10% or more school days (lower is better)</li>
  </ul>
  Schools are displayed on top of the historical redlining districts from the 1930s HOLC. The system automatically handles "NC" (not counted) values by treating them as missing data. Use the dropdown above the map to switch between indicators - the school dots will change colors accordingly, and a dynamic legend shows the color scale for each indicator.
</div>

<!-- Simple JavaScript to switch between maps -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Get the dropdown
  var dropdown = document.getElementById('standalone-indicator-select');
  
  // Function to show the selected map
  function showSelectedMap() {
    // Hide all maps
    var maps = document.querySelectorAll('.map-container');
    maps.forEach(function(map) {
      map.style.display = 'none';
    });
    
    // Show the selected map
    var selectedMap = document.getElementById('map-' + dropdown.value);
    if (selectedMap) {
      selectedMap.style.display = 'block';
      // Force redraw
      window.dispatchEvent(new Event('resize'));
    }
    
    console.log('Showing map:', dropdown.value);
  }
  
  // Set up event listener
  if (dropdown) {
    dropdown.addEventListener('change', showSelectedMap);
    
    // Show the initial map
    if (dropdown.options.length > 0) {
      // Select the first option if none selected
      if (!dropdown.value) {
        dropdown.selectedIndex = 0;
      }
      
      // Show the selected map
      setTimeout(showSelectedMap, 500);
    }
  }
  
  // Force initial map to show after a delay
  setTimeout(function() {
    showSelectedMap();
    console.log('Forced initial map display');
  }, 1000);
});
</script>

# 3. Building Student Opportunity Report - 2023-2024

The maps below visualize data from the Building Student Opportunity Report for Cleveland schools. Each indicator shows opportunities and resources available to students, with HOLC redlining districts displayed as background polygons.

<!-- Standalone dropdown for Student Opportunity maps -->
<div style="background-color: white; padding: 10px; margin-bottom: 15px; border-radius: 5px; border: 1px solid #ccc;">
  <strong>Select Student Opportunity Indicator:</strong>
  <select id="opportunity-indicator-select" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;">
    <option value="kindergarten" selected>All-Day Kindergarten Enrollment</option>
    <option value="pe">Physical Education/Wellness Course Enrollment</option>
    <option value="language">World Language Course Enrollment</option>
    <option value="cte">Career Technical Education Enrollment (Grades 7-12)</option>
    <option value="cocurricular">Cocurricular Activities Participation</option>
    <option value="advanced">Advanced Courses Participation (AP, IB, Honors, CCP)</option>
    <option value="gifted">Gifted Services</option>
    <option value="enrichment">Enrichment/Support Programs Outside School Day</option>
    <option value="breakfast">School Breakfast Program Participation</option>
    <option value="transportation">School Bus Transportation</option>
    <option value="technology">Portable Technology Devices Ratio</option>
  </select>
</div>

```{r opportunity-data-loading, echo=FALSE, message=FALSE, warning=FALSE}
# Load the Building Student Opportunity Report data
opportunity_data <- read_excel("~/digital_redlining/plot/datasets/23-24 Building Student Opportunity Report.xlsx", 
                               sheet = "By_Student_Group")

# Filter for "All Students" rows only
opportunity_all_students <- subset(opportunity_data, 
                                  opportunity_data$`Student Group` == "All Students")

# Create shorter names for the columns for easier handling
opportunity_columns <- list(
  kindergarten = "Percent of Kindergarten Students Enrolled in All-Day Kindergarten",
  pe = "Percent of Students Enrolled in a Physical Education or Wellness Course",
  language = "Percent of Students Enrolled in a World Language Course",
  cte = "Percent of Students in Grades 7-12 Who Are Enrolled in a Career Technical Education Course",
  cocurricular = "Percent of Students Participating in One or More Cocurricular Activities",
  advanced = "Percent of Students Participating in AP, IB, Honors, or CCP Courses",
  gifted = "Percent of Students Identified and Receiving Services as Gifted in Superior Cognitive Ability and Specific Academic Abilities Fields",
  enrichment = "Percent of Students Participating in Enrichment or Support Programs Offered by the District or Building Outside of the Normal School Day",
  breakfast = "Percent of Eligible Students Participating Each Day in a School Breakfast Program Offered by the District or Building",
  transportation = "Number of Students Who Are Transported by a School Bus Each School Day",
  technology = "Ratio of Portable Technology Devices That Students may Take Home to the Number of Students"
)

# Rename the columns for easier access
opportunity_renamed <- opportunity_all_students
opportunity_renamed$SchoolIRN <- opportunity_renamed$`Building IRN`
opportunity_renamed$SchoolName <- opportunity_renamed$`Building Name`

# Convert percentage strings to numeric values (handling "NC" as NA)
convert_percentage <- function(x) {
  if (is.character(x)) {
    if (x == "NC" || x == "NR" || x == "NRC" || x == "") {
      return(NA)
    } else {
      return(as.numeric(x) / 100)
    }
  } else if (is.numeric(x)) {
    return(x / 100)
  } else {
    return(NA)
  }
}

# Convert each column to numeric, handling non-percentage fields differently
for (short_name in names(opportunity_columns)) {
  col_name <- opportunity_columns[[short_name]]
  
  if (short_name %in% c("transportation", "technology")) {
    # Handle non-percentage fields
    opportunity_renamed[[short_name]] <- sapply(opportunity_renamed[[col_name]], function(x) {
      if (is.character(x)) {
        if (x %in% c("NC", "NR", "NRC", "")) {
          return(NA)
        } else {
          return(as.numeric(x))
        }
      } else {
        return(x)
      }
    })
  } else {
    # Handle percentage fields
    opportunity_renamed[[short_name]] <- sapply(opportunity_renamed[[col_name]], convert_percentage)
  }
}

# Merge with school coordinates
opportunity_schools <- cleveland_schools_data %>%
  select(SchoolIRN, SchoolName, Latitude, Longitude) %>%
  left_join(
    opportunity_renamed %>% 
      select(SchoolIRN, kindergarten, pe, language, cte, cocurricular, 
             advanced, gifted, enrichment, breakfast, transportation, technology),
    by = "SchoolIRN"
  )

# Create a clean dataset for mapping
opportunity_map_data <- data.frame(
  name = opportunity_schools$SchoolName,
  lat = opportunity_schools$Latitude,
  lng = opportunity_schools$Longitude,
  kindergarten = opportunity_schools$kindergarten,
  pe = opportunity_schools$pe,
  language = opportunity_schools$language,
  cte = opportunity_schools$cte,
  cocurricular = opportunity_schools$cocurricular,
  advanced = opportunity_schools$advanced,
  gifted = opportunity_schools$gifted,
  enrichment = opportunity_schools$enrichment,
  breakfast = opportunity_schools$breakfast,
  transportation = opportunity_schools$transportation,
  technology = opportunity_schools$technology,
  stringsAsFactors = FALSE
)

# Convert any remaining NA values to 0 for mapping
for (col in c("kindergarten", "pe", "language", "cte", "cocurricular", 
              "advanced", "gifted", "enrichment", "breakfast")) {
  # For percentage fields, use 0
  opportunity_map_data[[col]][is.na(opportunity_map_data[[col]])] <- 0
}

# For non-percentage fields, use median (or 0 if no data)
for (col in c("transportation", "technology")) {
  median_val <- median(opportunity_map_data[[col]], na.rm = TRUE)
  if (is.na(median_val)) median_val <- 0
  opportunity_map_data[[col]][is.na(opportunity_map_data[[col]])] <- median_val
}

# Create descriptions for each indicator for map popups
indicator_descriptions <- list(
  kindergarten = "All-Day Kindergarten Enrollment",
  pe = "Physical Education/Wellness Course Enrollment",
  language = "World Language Course Enrollment",
  cte = "Career Technical Education Enrollment (Grades 7-12)",
  cocurricular = "Cocurricular Activities Participation",
  advanced = "Advanced Courses Participation (AP, IB, Honors, CCP)",
  gifted = "Gifted Services",
  enrichment = "Enrichment/Support Programs Outside School Day",
  breakfast = "School Breakfast Program Participation",
  transportation = "Students Transported by School Bus",
  technology = "Portable Technology Devices Ratio"
)

# Print summary of data loaded
cat("Loaded Student Opportunity data for", nrow(opportunity_all_students), "schools\n")
cat("Available indicators:\n")
for (name in names(opportunity_columns)) {
  valid_count <- sum(!is.na(opportunity_map_data[[name]]))
  cat(" -", indicator_descriptions[[name]], ":", valid_count, "schools with data\n")
}
```

```{r opportunity-map-render, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=8}
# Create the basemap (reusing the same base map from section 2)
opportunity_basemap <- leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  setView(lng = -81.6944, lat = 41.4993, zoom = 11) 

# Add the redlining polygons
opportunity_basemap <- opportunity_basemap %>%
  addPolygons(
    data = redlining_data,
    fillColor = ~ifelse(grade %in% names(holc_colors), holc_colors[grade], "#CCCCCC"),
    fillOpacity = 0.5,
    color = "#444444",
    weight = 1,
    label = ~paste("Grade:", grade),
    group = "Redlining Districts"
  ) %>%
  addLegend(
    position = "bottomleft",
    colors = unname(holc_colors),
    labels = paste("Grade", names(holc_colors)),
    title = "HOLC Grades (1930s)",
    opacity = 0.7
  )

# Function to generate a map for a given indicator
create_opportunity_map <- function(data, indicator, title, is_percentage = TRUE) {
  # Create appropriate color palette
  if (is_percentage) {
    # For percentage fields (higher is better)
    pal <- colorNumeric(
      palette = c("#edf8fb", "#ccece6", "#99d8c9", "#66c2a4", "#41ae76", "#238b45", "#006d2c"),
      domain = c(0, 1)
    )
    
    # Format label differently for percentages
    label_format <- function(x) { paste0(round(x * 100, 1), "%") }
    popup_format <- function(name, value) { paste0("<b>", name, "</b><br>", title, ": ", 
                                                 ifelse(is.na(value), "No data", paste0(round(value * 100, 1), "%"))) }
    legend_title <- paste0(title, "<br><small>(Higher % is better)</small>")
  } else {
    # For non-percentage fields
    values <- data[[indicator]]
    values <- values[!is.na(values)]
    
    pal <- colorNumeric(
      palette = c("#edf8fb", "#ccece6", "#99d8c9", "#66c2a4", "#41ae76", "#238b45", "#006d2c"),
      domain = range(values)
    )
    
    # Format label differently for non-percentages
    label_format <- function(x) { as.character(round(x, 1)) }
    popup_format <- function(name, value) { paste0("<b>", name, "</b><br>", title, ": ", 
                                                 ifelse(is.na(value), "No data", round(value, 1))) }
    legend_title <- title
  }
  
  # Create the map
  map <- opportunity_basemap %>%
    addCircleMarkers(
      data = data,
      lng = ~lng,
      lat = ~lat,
      radius = 8,
      fillColor = ~pal(data[[indicator]]),
      fillOpacity = 1.0,
      color = "white",
      weight = 2,
      popup = ~popup_format(name, data[[indicator]]),
      label = ~name,
      group = "Schools"
    ) %>%
    addLegend(
      position = "bottomright",
      pal = pal,
      values = data[[indicator]],
      title = legend_title,
      opacity = 0.7,
      labFormat = if(is_percentage) labelFormat(suffix = "%", transform = function(x) x * 100) else labelFormat()
    )
  
  return(map)
}

# Create maps for each indicator
kindergarten_map <- create_opportunity_map(
  opportunity_map_data, 
  "kindergarten", 
  "All-Day Kindergarten Enrollment"
)

pe_map <- create_opportunity_map(
  opportunity_map_data, 
  "pe", 
  "Physical Education/Wellness Course Enrollment"
)

language_map <- create_opportunity_map(
  opportunity_map_data, 
  "language", 
  "World Language Course Enrollment"
)

cte_map <- create_opportunity_map(
  opportunity_map_data, 
  "cte", 
  "Career Technical Education Enrollment (Grades 7-12)"
)

cocurricular_map <- create_opportunity_map(
  opportunity_map_data, 
  "cocurricular", 
  "Cocurricular Activities Participation"
)

advanced_map <- create_opportunity_map(
  opportunity_map_data, 
  "advanced", 
  "Advanced Courses Participation (AP, IB, Honors, CCP)"
)

gifted_map <- create_opportunity_map(
  opportunity_map_data, 
  "gifted", 
  "Gifted Services"
)

enrichment_map <- create_opportunity_map(
  opportunity_map_data, 
  "enrichment", 
  "Enrichment/Support Programs Outside School Day"
)

breakfast_map <- create_opportunity_map(
  opportunity_map_data, 
  "breakfast", 
  "School Breakfast Program Participation"
)

transportation_map <- create_opportunity_map(
  opportunity_map_data, 
  "transportation", 
  "Students Transported by School Bus",
  is_percentage = FALSE
)

technology_map <- create_opportunity_map(
  opportunity_map_data, 
  "technology", 
  "Portable Technology Devices Ratio",
  is_percentage = FALSE
)
```

<!-- Create container divs for each opportunity map -->
<div id="map-kindergarten" class="map-container" style="display:none;">
```{r map-kindergarten, echo=FALSE}
kindergarten_map
```
</div>

<div id="map-pe" class="map-container" style="display:none;">
```{r map-pe, echo=FALSE}
pe_map
```
</div>

<div id="map-language" class="map-container" style="display:none;">
```{r map-language, echo=FALSE}
language_map
```
</div>

<div id="map-cte" class="map-container" style="display:none;">
```{r map-cte, echo=FALSE}
cte_map
```
</div>

<div id="map-cocurricular" class="map-container" style="display:none;">
```{r map-cocurricular, echo=FALSE}
cocurricular_map
```
</div>

<div id="map-advanced" class="map-container" style="display:none;">
```{r map-advanced, echo=FALSE}
advanced_map
```
</div>

<div id="map-gifted" class="map-container" style="display:none;">
```{r map-gifted, echo=FALSE}
gifted_map
```
</div>

<div id="map-enrichment" class="map-container" style="display:none;">
```{r map-enrichment, echo=FALSE}
enrichment_map
```
</div>

<div id="map-breakfast" class="map-container" style="display:none;">
```{r map-breakfast, echo=FALSE}
breakfast_map
```
</div>

<div id="map-transportation" class="map-container" style="display:none;">
```{r map-transportation, echo=FALSE}
transportation_map
```
</div>

<div id="map-technology" class="map-container" style="display:none;">
```{r map-technology, echo=FALSE}
technology_map
```
</div>

<!-- JavaScript to switch between opportunity maps -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Get the opportunity dropdown
  var opportunityDropdown = document.getElementById('opportunity-indicator-select');
  
  // Function to show the selected opportunity map
  function showSelectedOpportunityMap() {
    // Hide all opportunity maps
    var maps = document.querySelectorAll('.map-container');
    maps.forEach(function(map) {
      map.style.display = 'none';
    });
    
    // Show the selected opportunity map
    var selectedMap = document.getElementById('map-' + opportunityDropdown.value);
    if (selectedMap) {
      selectedMap.style.display = 'block';
      // Force redraw
      window.dispatchEvent(new Event('resize'));
    }
    
    console.log('Showing opportunity map:', opportunityDropdown.value);
  }
  
  // Set up event listener for opportunity dropdown
  if (opportunityDropdown) {
    opportunityDropdown.addEventListener('change', showSelectedOpportunityMap);
